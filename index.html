<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR 음성 안내 (TTS)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #555555;
      --accent: #0a7cff;
      --accent-2: #0c8b3f;
      --radius: 16px;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0b0b; --fg:#efefef; --muted:#aaaaaa; --accent:#4e9cff; --accent-2:#35b56e; }
    }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, "Malgun Gothic", Arial, sans-serif; background:var(--bg); color:var(--fg); line-height:1.6; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 24px; }
    header { margin-bottom: 16px; }
    h1 { font-size: clamp(1.4rem, 4.5vw, 2rem); margin: 0 0 8px; }
    p.lead { color: var(--muted); margin: 0 0 8px; }

    .controls {
      position: sticky; top: 0; z-index: 10; 
      background: color-mix(in lab, var(--bg) 92%, transparent);
      backdrop-filter: blur(6px);
      border: 1px solid color-mix(in lab, var(--fg) 12%, transparent);
      border-radius: var(--radius);
      padding: 12px; margin: 12px 0 16px;
      display: grid; gap: 8px;
    }
    .btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    button, select, input[type="range"] {
      font: inherit; border-radius: 12px; border: 1px solid color-mix(in lab, var(--fg) 16%, transparent);
      padding: 12px; background: color-mix(in lab, var(--bg) 96%, transparent); color: var(--fg);
    }
    button { cursor: pointer; font-weight: 600; }
    button.primary { background: var(--accent); color: white; border:none; }
    button.good { background: var(--accent-2); color: white; border:none; }
    button:focus, select:focus, input:focus { outline: 3px solid color-mix(in lab, var(--accent) 50%, transparent); outline-offset: 2px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center; }
    .status { font-size: 0.95rem; color: var(--muted); }
    .hidden { display:none !important; }

    .content {
      font-size: 1.125rem; /* 18px */
      line-height: 1.8;
    }
    .content p { margin: 0 0 1rem; }
    .big-start {
      display: grid; place-items: center; gap: 10px; padding: 16px; margin: 12px 0 0;
      border: 2px dashed color-mix(in lab, var(--fg) 25%, transparent); border-radius: var(--radius);
    }
    .big-start button { font-size: 1.1rem; padding: 14px 16px; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <a href="#main" class="sr-only">본문으로 건너뛰기</a>
  <div class="wrap">
    <header>
      <h1 id="title">전시 음성 안내</h1>
      <p class="lead" id="subtitle">QR 스캔 즉시 자동 재생을 시도합니다. 차단되면 아래 <strong>"재생"</strong> 버튼을 눌러 주세요.</p>
    </header>

    <section class="controls" aria-label="음성 재생 컨트롤">
      <div class="btns">
        <button id="playBtn" class="primary" aria-label="읽기 시작">재생</button>
        <button id="pauseBtn" aria-label="일시 정지">일시 정지</button>
        <button id="resumeBtn" aria-label="다시 시작">다시 시작</button>
        <button id="stopBtn" aria-label="정지">정지</button>
      </div>
      <div class="row" role="group" aria-label="읽기 속도">
        <label for="rate">속도 <span id="rateVal">1.0x</span></label>
        <input id="rate" type="range" min="0.7" max="1.6" value="1.0" step="0.1" />
      </div>
      <div class="row" role="group" aria-label="목소리 선택">
        <label for="voice">목소리</label>
        <select id="voice" aria-label="TTS 목소리 선택"></select>
      </div>
      <div class="status" id="status" aria-live="polite">상태: 준비됨</div>
    </section>

    <main id="main" class="content" tabindex="-1">
  <!-- ✅ 여기 텍스트를 전시별로 바꿔서 사용하세요. (이미지로 넣지 마세요) -->
  <article id="content">
    <h2>쉬운 미술관 안내서</h2>

    <h3>Section 1. ‘모든 가방’ 사용설명서</h3>
    <p><strong>‘모든 가방’이란?</strong></p>
    <p>'모든 가방(Modeun Gabang)'에는 미술관을 편안하게 관람할 수 있도록 도와주는 도구들이 들어 있어요. 모두가 함께, 모두를 위해 만든 특별한 예술 작품입니다. 모든 도구를 사용하지 않아도 괜찮아요. 필요할 때 꺼내 쓰고, 원할 때 다시 넣으시면 됩니다. ‘모든 가방’은 다음 관람객을 위해 깨끗이 다뤄주세요!</p>

    <p><strong>도구 소개</strong></p>
    <p><em>쉬운 미술관 안내서</em> – 이 책으로 가방 사용법, 관람 가이드, 감각지도, 쉬운 글 해설을 제공합니다.</p>
    <p><em>소통카드</em> – 도움을 요청할 때 보여줄 수 있습니다.</p>
    <p><em>헤드셋</em> – 시끄러운 소리를 막아줍니다.</p>
    <p><em>피젯 키링</em> – 손으로 만지면서 진정/집중 도움. 색상으로 신호 전달:
      <br>빨강: 도움이 필요해 보이면 먼저 다가와 주세요.
      <br>파랑: 작품을 가까이서 보고 싶어요.
    </p>
    <p><em>활동지</em> – 작품을 더 잘 느끼고 이해하도록 돕는 질문들.</p>
    <p><em>펜</em> – 활동지나 메모 작성.</p>
    <p><em>메모지</em> – 글로 소통하거나 적고 싶은 것 작성.</p>

    <p><strong>‘모든 가방’ 반납하기</strong></p>
    <p>관람이 끝나면, 전시실 앞 가방 거치대에 정리해주세요. 활동지는 가져가도 됩니다. 안내서, 소통카드, 헤드셋, 피젯 키링, 펜, 메모지는 가방에 다시 넣어주세요.</p>

    <h3>Section 2. 관람 가이드</h3>
    <p><strong>미술관 입장하기</strong> – 음식물·음료 반입 불가. 천장이 높아 소리 울림 있음.</p>
    <p><strong>안내데스크</strong> – 입구 왼쪽, 전시 안내·리플릿 제공. 휠체어·유아차 대여 가능. 뒤쪽에 놀이방·수유실.</p>
    <p><strong>화장실·정수기</strong> – 입구 오른쪽. 화장실은 전 층, 정수기는 1층·지하1층.</p>
    <p><strong>물품보관소</strong> – 입구 왼쪽, 카페 전 오른쪽 엘리베이터 → 지하1층.</p>
    <p><strong>전시실</strong> – 1~3층, 순서 자유. 계단·엘리베이터 이용 가능.</p>
    <p><strong>관람 도움</strong> – 검은 옷·카드목걸이 스태프에게 문의.</p>
    <p><strong>조용한 관람</strong> – 2층 상설전시(천경자, 가나아트 컬렉션).</p>
    <p><strong>기획전시실</strong> – 1~3층, 빛·소리 활용, 놀랄 수 있음.</p>
    <p><strong>휴식 공간</strong> – 각 층 복도, 창가, 서점 옆.</p>
    <p><strong>더 조용한 공간</strong> – 2층 엘리베이터 옆 도서자료실.</p>
    <p>운영시간: 화~토 10:00~18:00 (12~13시 점심시간 휴관).</p>

    <h3>Section 3. 감각지도</h3>
    <p>안내데스크, 화장실, 정수기, 엘리베이터, 전시실 위치 표시. 공간별 소음을 색과 점자로 표현.</p>

    <h3>‘모든 가방’(Modeun Gabang)</h3>
    <p>모두가 함께, 모두를 위해, 모두에게 필요한 미술관 관람 도구와 아이디어를 담은 예술 작품. 신체, 인지, 연령 차이 없이 예술을 즐길 수 있도록 다양한 참여자들과 협업해 완성. 저작권 보호됨.</p>
    <p>© 2025 미션잇(김병수), 이나영(에토프), 서울시립미술관. All rights reserved.</p>
    <p>주최: 서울시립미술관 / 기획: 김아영 외 / 참여 작가: 미션잇(김병수) 외</p>
    <p>서울시립미술관 – 04515 서울특별시 중구 덕수궁길 61 / 02-2124-8800 / sema.seoul.go.kr</p>
  </article>
</main>

    <div class="big-start" id="bigStart">
      <div>자동 재생이 차단된 경우 아래 버튼을 눌러 주세요.</div>
      <button class="good" id="bigPlay">음성 안내 시작</button>
    </div>

    <footer style="margin:24px 0 8px; color:var(--muted); font-size:0.95rem;">
      <p>접근성 팁: 화면을 두 손가락으로 아래로 쓸어내리면(아이폰) 현재 화면을 읽습니다. 안드로이드는 “선택해서 읽기”를 사용하실 수 있습니다.</p>
    </footer>
  </div>

  <script>
    // ===== 설정값 (필요 시 수정) =====
    const DEFAULT_LANG = new URLSearchParams(location.search).get('lang') || 'ko-KR';
    const REMOTE_SRC = new URLSearchParams(location.search).get('src'); // ?src=텍스트파일URL (옵션)
    // ==================================

    let utterQueue = []; // 문장 단위로 큐잉
    let speaking = false;
    let paused = false;

    const $content = document.getElementById('content');
    const $status = document.getElementById('status');
    const $play = document.getElementById('playBtn');
    const $pause = document.getElementById('pauseBtn');
    const $resume = document.getElementById('resumeBtn');
    const $stop = document.getElementById('stopBtn');
    const $bigStart = document.getElementById('bigStart');
    const $bigPlay = document.getElementById('bigPlay');
    const $voiceSel = document.getElementById('voice');
    const $rate = document.getElementById('rate');
    const $rateVal = document.getElementById('rateVal');

    function setStatus(msg) {
      $status.textContent = '상태: ' + msg;
    }

    function getText() {
      // 콘텐츠에서 화면에 보이는 텍스트만 추출
      return $content.innerText.trim();
    }

    function splitIntoChunks(text) {
      // 너무 긴 문장을 방지하기 위해 안전하게 분할
      const parts = text
        .replace(/\s+/g, ' ')
        .split(/([.!?。！？]\s+)/);

      const chunks = [];
      for (let i = 0; i < parts.length; i += 2) {
        let sentence = (parts[i] || '') + (parts[i+1] || '');
        sentence = sentence.trim();
        if (!sentence) continue;
        // 길면 추가 분할 (약 180자 단위)
        if (sentence.length > 180) {
          for (let j = 0; j < sentence.length; j += 180) {
            chunks.push(sentence.slice(j, j + 180));
          }
        } else {
          chunks.push(sentence);
        }
      }
      return chunks.length ? chunks : [text];
    }

    function fillVoices() {
      const voices = speechSynthesis.getVoices();
      $voiceSel.innerHTML = '';
      // ko-KR 우선, 그 다음 일반 한국어/기타
      const preferred = voices.filter(v => /ko-KR/i.test(v.lang));
      const others = voices.filter(v => !/ko-KR/i.test(v.lang));
      const all = [...preferred, ...others];
      all.forEach((v, idx) => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        if (idx === 0) opt.selected = true;
        $voiceSel.appendChild(opt);
      });
    }

    function makeUtter(text) {
      const u = new SpeechSynthesisUtterance(text);
      const chosen = Array.from(speechSynthesis.getVoices()).find(v => v.name === $voiceSel.value) ||
                     Array.from(speechSynthesis.getVoices()).find(v => v.lang === DEFAULT_LANG);
      if (chosen) u.voice = chosen;
      u.lang = chosen?.lang || DEFAULT_LANG;
      u.rate = parseFloat($rate.value || '1.0');
      u.onstart = () => setStatus('읽는 중…');
      u.onend = () => {
        if (utterQueue.length) {
          speechSynthesis.speak(utterQueue.shift());
        } else {
          speaking = false; setStatus('완료');
        }
      };
      u.onerror = (e) => setStatus('오류: ' + (e.error || '읽기 실패'));
      return u;
    }

    function speakNow() {
      speechSynthesis.cancel();
      utterQueue = splitIntoChunks(getText()).map(makeUtter);
      if (!utterQueue.length) { setStatus('읽을 텍스트가 없습니다'); return; }
      speaking = true; paused = false;
      speechSynthesis.speak(utterQueue.shift());
      setStatus('읽는 중…');
    }

    function tryAutoStart() {
      // 일부 브라우저(iOS 등)는 사용자 제스처 필요 → 실패 시 큰 시작 버튼 노출
      try {
        speakNow();
        // iOS에서 즉시 실패 감지 어려움 → 600ms 후에 아직 대기면 버튼 노출
        setTimeout(() => {
          const isSpeaking = speechSynthesis.speaking;
          if (!isSpeaking) $bigStart.classList.remove('hidden'); else $bigStart.classList.add('hidden');
        }, 600);
      } catch (e) {
        $bigStart.classList.remove('hidden');
      }
    }

    // 이벤트 바인딩
    $play.addEventListener('click', speakNow);
    $bigPlay.addEventListener('click', () => { $bigStart.classList.add('hidden'); speakNow(); });
    $pause.addEventListener('click', () => { if (speechSynthesis.speaking) { speechSynthesis.pause(); paused = true; setStatus('일시 정지'); }});
    $resume.addEventListener('click', () => { if (paused) { speechSynthesis.resume(); paused = false; setStatus('다시 시작'); }});
    $stop.addEventListener('click', () => { speechSynthesis.cancel(); utterQueue = []; speaking = false; setStatus('정지됨'); });
    $rate.addEventListener('input', () => { $rateVal.textContent = `${parseFloat($rate.value).toFixed(1)}x`; });

    // 브라우저에서 음성 목록 로드
    if ('speechSynthesis' in window) {
      fillVoices();
      window.speechSynthesis.onvoiceschanged = fillVoices;
    } else {
      setStatus('이 브라우저는 TTS를 지원하지 않습니다. 기기의 접근성 읽기 기능을 사용해 주세요.');
    }

    // 원격 텍스트 소스가 지정된 경우 가져와서 본문 교체 (?src=URL)
    async function maybeLoadRemote() {
      if (!REMOTE_SRC) return;
      try {
        setStatus('텍스트 불러오는 중…');
        const res = await fetch(REMOTE_SRC, { cache: 'no-store' });
        const txt = await res.text();
        $content.innerText = txt.trim();
        setStatus('불러옴');
      } catch (e) {
        setStatus('텍스트 불러오기 실패');
      }
    }

    // 페이지 진입 시 자동 시작 시도
    (async function init() {
      await maybeLoadRemote();
      // iOS 사용자 제스처 우회: 첫 터치에서 한번 더 시도
      document.addEventListener('touchstart', onceKick, { passive: true, once: true });
      function onceKick() { if (!speechSynthesis.speaking) speakNow(); }
      tryAutoStart();
    })();
  </script>
</body>
</html>
